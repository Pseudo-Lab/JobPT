name: Deploy JobPT to Oracle Server

on:
  push:
    branches:
      - main
      - dev
      - ci/deploy-test
  workflow_dispatch: # 수동 실행 허용

jobs:
  # ========================================
  # 🧪 test 배포 (deploy 브랜치)
  # ========================================
  deploy-test:
    if: github.ref_name == 'ci/deploy-test'
    name: 🧪 Deploy JobPT (Test / Deploy branch)
    runs-on: oracle
    environment: dev_deploy

    steps:
      - name: Checkout branch
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for DEV
        run: |
          set -e
          echo "APP_HOST=${{ vars.APP_HOST }}" >> .env
          echo "ENVIRONMENT=development" >> .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "UPSTAGE_API_KEY=${{ secrets.UPSTAGE_API_KEY }}" >> .env
          echo "SMITHERY_API_KEY=${{ secrets.SMITHERY_API_KEY }}" >> .env
          echo "PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" >> .env
          echo "TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}" >> .env
          echo "FRONTEND_CORS_ORIGIN=${{ vars.FRONTEND_CORS_ORIGIN }}" >> .env
          echo "LANGFUSE_PUBLIC_KEY=${{ secrets.LANGFUSE_PUBLIC_KEY }}" >> .env
          echo "LANGFUSE_SECRET_KEY=${{ secrets.LANGFUSE_SECRET_KEY }}" >> .env

      - name: 🚀 Deploy to DEV
        run: |
          docker compose down --remove-orphans
          docker compose up -d --build

      - name: Cleanup old Docker images
        run: docker image prune -f